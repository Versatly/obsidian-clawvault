/**
 * ClawVault Commands
 * Command palette registrations
 * 
 * Canvas dashboards removed — Kanban plugin is the task UI.
 * Plugin focuses on: status panel, task creation, vault stats.
 */

import { Notice } from "obsidian";
import type ClawVaultPlugin from "./main";
import { COMMAND_IDS, STATUS_VIEW_TYPE } from "./constants";
import {
	BlockedModal,
	CaptureModal,
	OpenLoopsModal,
	TaskModal,
} from "./modals";

/**
 * Register all ClawVault commands
 */
export function registerCommands(plugin: ClawVaultPlugin): void {
	// Sync now command
	plugin.addCommand({
		id: COMMAND_IDS.SYNC_NOW,
		name: "ClawVault: Sync Now",
		hotkeys: [{ modifiers: ["Ctrl", "Shift"], key: "s" }],
		callback: () => {
			void plugin.syncNow("full");
		},
	});

	// Pull-only sync command
	plugin.addCommand({
		id: COMMAND_IDS.SYNC_PULL,
		name: "ClawVault: Sync Pull",
		callback: () => {
			void plugin.syncNow("pull");
		},
	});

	// Push-only sync command
	plugin.addCommand({
		id: COMMAND_IDS.SYNC_PUSH,
		name: "ClawVault: Sync Push",
		callback: () => {
			void plugin.syncNow("push");
		},
	});

	// Focus sync status in the sidebar
	plugin.addCommand({
		id: COMMAND_IDS.SHOW_SYNC_STATUS,
		name: "ClawVault: Show Sync Status",
		callback: () => {
			void plugin.focusSyncStatusSection();
		},
	});

	// Open sync settings
	plugin.addCommand({
		id: COMMAND_IDS.CONFIGURE_SYNC,
		name: "ClawVault: Configure Sync",
		callback: () => {
			plugin.openPluginSettings();
		},
	});

	// Quick Capture command
	plugin.addCommand({
		id: COMMAND_IDS.QUICK_CAPTURE,
		name: "ClawVault: Quick Capture",
		hotkeys: [{ modifiers: ["Ctrl", "Shift"], key: "c" }],
		callback: () => {
			new CaptureModal(plugin.app).open();
		},
	});

	// Add Task command
	plugin.addCommand({
		id: COMMAND_IDS.ADD_TASK,
		name: "ClawVault: Add Task",
		hotkeys: [{ modifiers: ["Ctrl", "Shift"], key: "t" }],
		callback: () => {
			new TaskModal(plugin.app).open();
		},
	});

	// View Blocked command
	plugin.addCommand({
		id: COMMAND_IDS.VIEW_BLOCKED,
		name: "ClawVault: View Blocked Tasks",
		callback: () => {
			new BlockedModal(plugin.app, plugin.vaultReader).open();
		},
	});

	// Open Status Panel command
	plugin.addCommand({
		id: COMMAND_IDS.OPEN_STATUS_PANEL,
		name: "ClawVault: Open Status Panel",
		callback: () => {
			void activateStatusView(plugin);
		},
	});

	// Open Kanban Board command
	plugin.addCommand({
		id: "clawvault-open-kanban",
		name: "ClawVault: Open Kanban Board",
		callback: () => {
			void plugin.app.workspace.openLinkText("Board.md", "", "tab");
		},
	});

	// Force Refresh Stats command
	plugin.addCommand({
		id: COMMAND_IDS.REFRESH_STATS,
		name: "ClawVault: Refresh Stats",
		callback: () => {
			void plugin.refreshAll();
		},
	});

	// Show Open Loops command
	plugin.addCommand({
		id: COMMAND_IDS.SHOW_OPEN_LOOPS,
		name: "ClawVault: Show Open Loops",
		callback: () => {
			new OpenLoopsModal(plugin.app, plugin.vaultReader).open();
		},
	});

	// Setup Graph Colors command
	plugin.addCommand({
		id: "clawvault-setup-graph-colors",
		name: "ClawVault: Setup graph colors (neural style)",
		callback: () => {
			void setupGraphColors(plugin);
		},
	});
}

/**
 * Activate the status view in the right sidebar
 */
async function activateStatusView(plugin: ClawVaultPlugin): Promise<void> {
	const { workspace } = plugin.app;
	let leaf = workspace.getLeavesOfType(STATUS_VIEW_TYPE)[0];

	if (!leaf) {
		const rightLeaf = workspace.getRightLeaf(false);
		if (rightLeaf) {
			await rightLeaf.setViewState({
				type: STATUS_VIEW_TYPE,
				active: true,
			});
			leaf = rightLeaf;
		}
	}

	if (leaf) {
		await workspace.revealLeaf(leaf);
	}
}

/**
 * Setup neural-style graph colors
 */
async function setupGraphColors(plugin: ClawVaultPlugin): Promise<void> {
	try {
		const adapter = plugin.app.vault.adapter;

		// 1. Write the CSS snippet
		const snippetPath = ".obsidian/snippets/clawvault-graph.css";
		const snippetCSS = `/* ClawVault Graph Colors — Neural Style */
/* Auto-generated by ClawVault plugin. Dark bg, colored nodes, green links. */

.graph-view.color-fill {
  color: #0a0e17;
}
.graph-view.color-line {
  color: #1a3d2a;
}
.graph-view.color-text {
  color: #8892a0;
}
.graph-view.color-fill-highlight {
  color: #e8a430;
}
.graph-view.color-line-highlight {
  color: #2a7d4a;
}`;

		const snippetDir = ".obsidian/snippets";
		if (!(await adapter.exists(snippetDir))) {
			await adapter.mkdir(snippetDir);
		}
		await adapter.write(snippetPath, snippetCSS);

		// 2. Update graph.json with colorGroups
		const config = await plugin.vaultReader.readConfig();
		const categories = config?.categories ?? [
			"tasks", "decisions", "people", "projects", "lessons",
			"commitments", "inbox", "backlog",
		];

		const categoryColors: Record<string, string> = {
			tasks: "#e8a430",
			decisions: "#e85d4a",
			people: "#4a90e8",
			projects: "#4ae85d",
			lessons: "#9b59b6",
			commitments: "#e8a430",
			inbox: "#f39c12",
			backlog: "#95a5a6",
			patterns: "#2ecc71",
			goals: "#e67e22",
			research: "#3498db",
			agents: "#1abc9c",
			handoffs: "#e74c3c",
			templates: "#7f8c8d",
			preferences: "#9b59b6",
			transcripts: "#34495e",
		};

		const colorGroups = categories
			.filter((cat) => categoryColors[cat])
			.map((cat) => ({
				query: `path:${cat}/`,
				color: { a: 1, rgb: hexToRgbInt(categoryColors[cat] ?? "#7f8c8d") },
			}));

		const graphConfigPath = ".obsidian/graph.json";
		let graphConfig: Record<string, unknown> = {};
		try {
			if (await adapter.exists(graphConfigPath)) {
				graphConfig = JSON.parse(await adapter.read(graphConfigPath)) as Record<string, unknown>;
			}
		} catch { /* fresh config */ }

		graphConfig["colorGroups"] = colorGroups;
		await adapter.write(graphConfigPath, JSON.stringify(graphConfig, null, 2));

		// 3. Enable the CSS snippet
		const appearancePath = ".obsidian/appearance.json";
		let appearance: Record<string, unknown> = {};
		try {
			if (await adapter.exists(appearancePath)) {
				appearance = JSON.parse(await adapter.read(appearancePath)) as Record<string, unknown>;
			}
		} catch { /* fresh */ }

		const enabledSnippets = Array.isArray(appearance["enabledCssSnippets"])
			? (appearance["enabledCssSnippets"] as string[])
			: [];
		if (!enabledSnippets.includes("clawvault-graph")) {
			enabledSnippets.push("clawvault-graph");
		}
		appearance["enabledCssSnippets"] = enabledSnippets;
		await adapter.write(appearancePath, JSON.stringify(appearance, null, 2));

		new Notice("ClawVault: Graph colors configured (neural style). Reload Obsidian to see changes.");
	} catch (error) {
		new Notice(`ClawVault: Failed to setup graph colors: ${error instanceof Error ? error.message : "unknown"}`);
	}
}

function hexToRgbInt(hex: string): number {
	const cleaned = hex.replace("#", "");
	return parseInt(cleaned, 16);
}
